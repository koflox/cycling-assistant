name: Project Stats

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build & Release"]
    types: [completed]
    branches: [main]

jobs:
  stats:
    name: Calculate Project Stats
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Android build environment
        uses: ./.github/actions/setup-android

      - name: Run tests with coverage
        run: gradle koverXmlReport --build-cache

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERED=$(grep -oP 'LINE.*?covered="\K[0-9]+' build/reports/kover/report.xml | tail -1)
          MISSED=$(grep -oP 'LINE.*?missed="\K[0-9]+' build/reports/kover/report.xml | tail -1)
          TOTAL=$((COVERED + MISSED))
          if [ $TOTAL -gt 0 ]; then
            PERCENT=$((COVERED * 100 / TOTAL))
          else
            PERCENT=0
          fi
          echo "Coverage: ${PERCENT}%"
          echo "percentage=$PERCENT" >> $GITHUB_OUTPUT
          if [ $PERCENT -ge 60 ]; then
            echo "color=brightgreen" >> $GITHUB_OUTPUT
          elif [ $PERCENT -ge 45 ]; then
            echo "color=green" >> $GITHUB_OUTPUT
          elif [ $PERCENT -ge 30 ]; then
            echo "color=yellow" >> $GITHUB_OUTPUT
          else
            echo "color=red" >> $GITHUB_OUTPUT
          fi

      - name: Update Coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          color: ${{ steps.coverage.outputs.color }}

      - name: Calculate stats
        id: stats
        run: |
          # Lines of code (Kotlin only, excluding build/generated)
          LOC=$(find . -name '*.kt' \
            -not -path '*/build/*' \
            -not -path '*/generated/*' \
            | xargs cat | wc -l)
          echo "Lines of Kotlin code: $LOC"

          # Modules count from settings.gradle.kts (include statements)
          MODULES=$(grep -c '^include(' settings.gradle.kts)
          echo "Modules: $MODULES"

          # Screens count (Composable *Route functions, excluding private/non-composable)
          SCREENS=$(grep -rn 'fun [A-Z][a-zA-Z]*Route(' --include='*.kt' \
            --exclude-dir=build \
            | grep -v 'private ' \
            | grep -v 'fun sessionCompletionRoute' \
            | grep -v 'fun animateCameraToRoute' \
            | wc -l)
          echo "Screens: $SCREENS"

          # Workflows count
          WORKFLOWS=$(ls -1 .github/workflows/*.yml 2>/dev/null | wc -l)
          echo "Workflows: $WORKFLOWS"

          # Format LOC with K suffix
          if [ "$LOC" -ge 1000 ]; then
            LOC_DISPLAY="$(echo "scale=1; $LOC / 1000" | bc)K"
          else
            LOC_DISPLAY="$LOC"
          fi

          echo "loc=$LOC_DISPLAY" >> $GITHUB_OUTPUT
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "screens=$SCREENS" >> $GITHUB_OUTPUT
          echo "workflows=$WORKFLOWS" >> $GITHUB_OUTPUT

      - name: Update Lines of Code badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: loc.json
          label: lines of code
          message: ${{ steps.stats.outputs.loc }}
          color: blue

      - name: Update Modules badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: modules.json
          label: modules
          message: ${{ steps.stats.outputs.modules }}
          color: blue

      - name: Update Screens badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: screens.json
          label: screens
          message: ${{ steps.stats.outputs.screens }}
          color: blue

      - name: Update Workflows badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: workflows.json
          label: CI workflows
          message: ${{ steps.stats.outputs.workflows }}
          color: blue
